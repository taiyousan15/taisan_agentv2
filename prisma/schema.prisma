generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String   @id @default(cuid())
  clerkId       String   @unique @map("clerk_id")
  email         String   @unique
  displayName   String?  @map("display_name")
  avatarUrl     String?  @map("avatar_url")
  bio           String?
  role          Role     @default(MEMBER)
  tier          Tier     @default(BRONZE)
  totalMiles    Int      @default(0) @map("total_miles")
  lifetimeMiles Int      @default(0) @map("lifetime_miles")
  version       Int      @default(0)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  transactions       MileTransaction[]
  badges             UserBadge[]
  streaks            Streak?
  notifications      Notification[]
  eventRegistrations EventRegistration[]
  exchangeOrders     ExchangeOrder[]
  missionProgress    MissionProgress[]

  @@map("users")
}

enum Role {
  MEMBER
  ADMIN
  SUPER_ADMIN
}

enum Tier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

model MileTransaction {
  id             String          @id @default(cuid())
  userId         String          @map("user_id")
  amount         Int
  type           TransactionType
  source         String
  description    String?
  metadata       Json?
  idempotencyKey String?         @unique @map("idempotency_key")
  createdAt      DateTime        @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([source])
  @@map("mile_transactions")
}

enum TransactionType {
  EARN
  REDEEM
  ADJUST
  EXPIRE
}

model Badge {
  id          String        @id @default(cuid())
  name        String        @unique
  description String
  iconUrl     String?       @map("icon_url")
  category    BadgeCategory
  rarity      BadgeRarity
  condition   Json
  isActive    Boolean       @default(true) @map("is_active")
  createdAt   DateTime      @default(now()) @map("created_at")

  userBadges UserBadge[]

  @@map("badges")
}

enum BadgeCategory {
  BEGINNER
  LEARNING
  CONTRIBUTION
  EVENT
  STREAK
  SPECIAL
}

enum BadgeRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
}

model UserBadge {
  id       String   @id @default(cuid())
  userId   String   @map("user_id")
  badgeId  String   @map("badge_id")
  earnedAt DateTime @default(now()) @map("earned_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id])

  @@unique([userId, badgeId])
  @@map("user_badges")
}

model Streak {
  id                   String    @id @default(cuid())
  userId               String    @unique @map("user_id")
  currentStreak        Int       @default(0) @map("current_streak")
  longestStreak        Int       @default(0) @map("longest_streak")
  lastLoginDate        DateTime? @map("last_login_date")
  freezesRemaining     Int       @default(2) @map("freezes_remaining")
  freezesUsedThisMonth Int       @default(0) @map("freezes_used_this_month")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("streaks")
}

model MileRule {
  id         String   @id @default(cuid())
  actionCode String   @unique @map("action_code")
  actionName String   @map("action_name")
  baseMiles  Int      @map("base_miles")
  dailyLimit Int?     @map("daily_limit")
  condition  String?
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("mile_rules")
}

model Event {
  id          String    @id @default(cuid())
  title       String
  description String
  eventType   EventType @map("event_type")
  startDate   DateTime  @map("start_date")
  endDate     DateTime? @map("end_date")
  location    String?
  capacity    Int?
  milesReward Int       @default(0) @map("miles_reward")
  qrCode      String?   @unique @map("qr_code")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  registrations EventRegistration[]

  @@map("events")
}

enum EventType {
  GROUP_CONSULT
  OFFLINE_MEETUP
  ONLINE_SEMINAR
  SPECIAL
}

model EventRegistration {
  id          String             @id @default(cuid())
  userId      String             @map("user_id")
  eventId     String             @map("event_id")
  status      RegistrationStatus @default(REGISTERED)
  checkedInAt DateTime?          @map("checked_in_at")
  createdAt   DateTime           @default(now()) @map("created_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@map("event_registrations")
}

enum RegistrationStatus {
  REGISTERED
  CHECKED_IN
  CANCELLED
  NO_SHOW
}

model ExchangeItem {
  id            String           @id @default(cuid())
  name          String
  description   String
  imageUrl      String?          @map("image_url")
  category      ExchangeCategory
  requiredMiles Int              @map("required_miles")
  stock         Int?
  isActive      Boolean          @default(true) @map("is_active")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  orders ExchangeOrder[]

  @@map("exchange_items")
}

enum ExchangeCategory {
  PHYSICAL
  DIGITAL
  SERVICE
  PERMISSION
  DISCOUNT
  EXPERIENCE
}

model ExchangeOrder {
  id              String      @id @default(cuid())
  userId          String      @map("user_id")
  itemId          String      @map("item_id")
  milesSpent      Int         @map("miles_spent")
  status          OrderStatus @default(PENDING)
  shippingAddress Json?       @map("shipping_address")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  user User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  item ExchangeItem @relation(fields: [itemId], references: [id])

  @@map("exchange_orders")
}

enum OrderStatus {
  PENDING
  APPROVED
  SHIPPED
  DELIVERED
  CANCELLED
}

model Mission {
  id          String @id @default(cuid())
  title       String
  description String
  actionCode  String @map("action_code")
  targetCount Int    @default(1) @map("target_count")
  rewardMiles Int    @map("reward_miles")
  isActive    Boolean @default(true) @map("is_active")

  progress MissionProgress[]

  @@map("missions")
}

model MissionProgress {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  missionId    String    @map("mission_id")
  currentCount Int       @default(0) @map("current_count")
  completed    Boolean   @default(false)
  assignedDate DateTime  @map("assigned_date")
  completedAt  DateTime? @map("completed_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  mission Mission @relation(fields: [missionId], references: [id])

  @@unique([userId, missionId, assignedDate])
  @@map("mission_progress")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  type      String
  title     String
  message   String
  data      Json?
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("notifications")
}

model AuditLog {
  id        String   @id @default(cuid())
  actorId   String   @map("actor_id")
  action    String
  target    String
  targetId  String?  @map("target_id")
  details   Json?
  createdAt DateTime @default(now()) @map("created_at")

  @@index([actorId])
  @@index([target, targetId])
  @@map("audit_logs")
}

model IdempotencyKey {
  key       String   @id
  userId    String   @map("user_id")
  result    Json?
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at")

  @@index([expiresAt])
  @@map("idempotency_keys")
}
