# TAISUN Agent 2026 システムアーキテクチャ

## .mdファイルの役割と参照順序

Claude Codeがプロンプトを受け取ったとき、システムは以下の順序でファイルを参照します。

---

## 参照順序（優先度順）

```
┌─────────────────────────────────────────────────────────────────┐
│  Level 1: 自動注入（セッション開始時に必ず読み込み）            │
├─────────────────────────────────────────────────────────────────┤
│  ① .claude/CLAUDE.md                                           │
│     → 絶対遵守ルール、13層防御、PRE-FLIGHT CHECKS               │
│     → すべての行動の最上位制約                                  │
│     → 【重要】115行に最適化済み（コンテキスト効率）             │
│                                                                 │
│  ② .claude/settings.json                                       │
│     → Hooks設定、パーミッション、品質ゲート                    │
│     → SessionStart/PreToolUse/PostToolUse/SessionEnd           │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Level 2: 状態ファイル（存在する場合に注入）                    │
├─────────────────────────────────────────────────────────────────┤
│  ③ .workflow_state.json                                        │
│     → 現在のワークフローフェーズ                                │
│     → ベースラインファイル一覧                                  │
│     → 読み込み済みファイル履歴                                  │
│                                                                 │
│  ④ SESSION_HANDOFF.md                                          │
│     → 前セッションからの引き継ぎ                               │
│     → 未完了タスク、重要コンテキスト                           │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Level 3: オンデマンド参照（タスクに応じて読み込み）            │
├─────────────────────────────────────────────────────────────────┤
│  ⑤ .claude/agents/*.md                                         │
│     → 82個のエージェント定義                                   │
│     → タスク種別に応じて1-3個を動的に選択                      │
│     → AIT42 Coordinatorが最適なエージェントを選択              │
│                                                                 │
│  ⑥ .claude/skills/*/instructions.md                            │
│     → 77個のスキル定義                                         │
│     → Skillツール呼び出し時にのみ読み込み                      │
│     → スキルマッピングで自動強制される場合あり                  │
│                                                                 │
│  ⑦ .claude/commands/*.md                                       │
│     → 82個のコマンド定義                                       │
│     → /コマンド実行時にのみ読み込み                            │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Level 4: ルール・ポリシー（必要に応じて参照）                  │
├─────────────────────────────────────────────────────────────────┤
│  ⑧ .claude/rules/context-management.md                         │
│     → コンテキスト管理ガイドライン                             │
│     → MCP数制限、ファイル読み込み推奨値                        │
│                                                                 │
│  ⑨ config/workflows/*.json                                     │
│     → ワークフロー定義（Phase管理）                            │
│     → video_generation_v1, coding_change_v1 等                  │
│                                                                 │
│  ⑩ config/workflow-guardian/policies/*.json                    │
│     → ポリシー定義（フェーズ別許可操作）                       │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Level 5: 記憶・学習（長期参照）                                │
├─────────────────────────────────────────────────────────────────┤
│  ⑪ .claude/memory.md                                           │
│     → 長期記憶・学習ルール                                     │
│                                                                 │
│  ⑫ .claude/pins.md                                             │
│     → ピン留め台帳（修正対象の固定）                           │
│                                                                 │
│  ⑬ .claude/directives.md                                       │
│     → 指示台帳（タスク記録）                                   │
│                                                                 │
│  ⑭ .claude/traceability.yml                                    │
│     → DoD→変更→テスト対応表                                    │
│                                                                 │
│  ⑮ .claude/hooks/mistakes.md                                   │
│     → ミス台帳（再発防止）                                     │
│                                                                 │
│  ⑯ memory_bank/                                                │
│     → 永続メモリストレージ                                     │
└─────────────────────────────────────────────────────────────────┘
```

---

## 各ファイルの詳細

### Level 1: 自動注入

| ファイル | 行数 | 役割 | 読み込みタイミング |
|----------|------|------|-------------------|
| `.claude/CLAUDE.md` | 115 | 絶対遵守ルール | **常に** |
| `.claude/settings.json` | ~100 | Hooks/パーミッション | **常に** |

### Level 2: 状態ファイル

| ファイル | 役割 | 読み込みタイミング |
|----------|------|-------------------|
| `.workflow_state.json` | フェーズ状態 | 存在時 |
| `SESSION_HANDOFF.md` | セッション引き継ぎ | 存在時 |

### Level 3: オンデマンド

| ディレクトリ | ファイル数 | 役割 | 読み込みタイミング |
|-------------|-----------|------|-------------------|
| `.claude/agents/` | 82 | エージェント定義 | タスク実行時 |
| `.claude/skills/` | 77 | スキル定義 | Skillツール呼び出し時 |
| `.claude/commands/` | 82 | コマンド定義 | /コマンド実行時 |

### Level 4-5: ルール・記憶

| ファイル | 役割 |
|----------|------|
| `context-management.md` | コンテキスト管理ガイド |
| `workflows/*.json` | ワークフロー定義 |
| `policies/*.json` | ポリシー定義 |
| `memory.md` | 長期記憶 |
| `pins.md` | ピン留め |
| `mistakes.md` | ミス台帳 |

---

## コンテキスト汚染防止の設計

### 原則1: 遅延読み込み（Lazy Loading）
```
エージェント/スキル/コマンドは必要になるまで読み込まない
→ 82エージェント × 2000行 = 164,000行を常時読み込まない
```

### 原則2: CLAUDE.mdのスリム化
```
Before: 484行 / 18KB
After:  115行 / 4KB
削減:   76%
```

### 原則3: 詳細は参照先に委譲
```
CLAUDE.mdには「詳細は.claude/agents/を参照」と書く
→ リスト羅列をしない
```

### 原則4: 自動生成セクションの分離
```
claude-mem-context は CLAUDE.md の末尾に分離
→ 人間が編集する部分と自動生成部分を明確に分離
```

---

## Hooks実行フロー

```
┌─────────────────────────────────────────────────────────────────┐
│  SessionStart（セッション開始時）                               │
│  → workflow-sessionstart-injector.js                           │
│  → .workflow_state.json を読み込み、状態を注入                  │
├─────────────────────────────────────────────────────────────────┤
│  PreToolUse（ツール実行前）                                     │
│  → unified-guard.js（Bash/Write/Edit）                         │
│  → Layer 2-9 のチェックを実行                                   │
│  → 違反時は exit code 2 でブロック                              │
├─────────────────────────────────────────────────────────────────┤
│  PostToolUse（ツール実行後）                                    │
│  → definition-lint-gate.js（Write/Edit）                       │
│  → 定義ファイルの検証                                          │
├─────────────────────────────────────────────────────────────────┤
│  SessionEnd（セッション終了時）                                 │
│  → session-handoff-generator.js                                │
│  → SESSION_HANDOFF.md を生成                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## メタプロンプト処理フロー

ユーザーがプロンプトを入力したとき：

```
1. CLAUDE.md を読み込み（自動）
2. settings.json の Hooks を確認（自動）
3. .workflow_state.json があれば読み込み（自動）

4. プロンプトを解析
   → skill-mapping.json でスキル自動マッピング
   → 複雑タスク検出（agent-enforcement-guard）

5. タスク実行
   → PreToolUse Hooks でチェック
   → ツール実行
   → PostToolUse Hooks でチェック

6. 必要に応じてエージェント/スキルを読み込み
   → .claude/agents/xxx.md
   → .claude/skills/xxx/instructions.md

7. セッション終了時
   → SESSION_HANDOFF.md 生成
   → メモリ保存
```

---

## 推奨されるコンテキスト構成

| 項目 | 推奨値 | 理由 |
|------|--------|------|
| CLAUDE.md | 100-150行 | 常時読み込みのため最小化 |
| 有効MCP | 10個以下 | コンテキスト縮小防止 |
| 同時読み込みエージェント | 1-3個 | 必要最小限 |
| 同時読み込みスキル | 1-2個 | 必要最小限 |

---

## トラブルシューティング

### コンテキストが狭まった感じがする場合
```bash
# MCP数を確認
cat .mcp.json | grep -c '"disabled": false'

# 不要なMCPを無効化
# .mcp.json で "disabled": true に設定
```

### Hooksが動作しない場合
```bash
# 設定を確認
cat .claude/settings.json | grep -A 20 "hooks"

# 実行権限を確認
ls -la .claude/hooks/*.js
```

### 状態がリセットされる場合
```bash
# 状態ファイルを確認
cat .workflow_state.json
cat SESSION_HANDOFF.md
```
